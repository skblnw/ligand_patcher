# GROMACS Ligand Patcher

<p align="center">
  <img src="https://img.shields.io/badge/python-3.8%2B-blue.svg" alt="Python Version">
  <img src="https://img.shields.io/badge/license-MIT-green.svg" alt="License">
  <img src="https://img.shields.io/badge/GROMACS-2019.2%2B-orange.svg" alt="GROMACS">
  <img src="https://img.shields.io/badge/CHARMM--GUI-compatible-purple.svg" alt="CHARMM-GUI">
</p>

A streamlined Python tool for integrating ligands into CHARMM-GUI generated membrane protein systems for GROMACS molecular dynamics simulations.

## ğŸ¯ Overview

**GROMACS Ligand Patcher** automates the process of adding ligands to membrane protein systems generated by CHARMM-GUI. In just three simple steps, it handles coordinate integration, topology updates, and equilibration restraint configuration.

### Key Features

- **ğŸš€ Simple Integration**: Direct coordinate insertion from ligand PDB to system GRO files
- **ğŸ“ Automatic Topology Updates**: Seamless ligand topology and parameter integration
- **âš–ï¸ Equilibration Restraints**: Automated restraint configuration for stable equilibration
- **ğŸ”’ Safe Operations**: Automatic backup of original files
- **ğŸ§ª Dry Run Mode**: Preview changes before applying them
- **âœ… Comprehensive Testing**: Built-in validation and testing suite

## ğŸ“‹ Requirements

- Python 3.8 or higher
- CHARMM-GUI generated system and ligand directories
- GROMACS 2019.2 or higher (for running simulations)

## ğŸš€ Quick Start

### Installation

#### Option 1: Using Conda (Recommended)

```bash
git clone https://github.com/yourusername/ligand-patcher.git
cd ligand-patcher
conda env create -f environment.yml
conda activate ligand-patcher
ligand-patcher --version
```

#### Option 2: Using Python venv

```bash
git clone https://github.com/yourusername/ligand-patcher.git
cd ligand-patcher
python -m venv ligand-patcher-env
source ligand-patcher-env/bin/activate  # Windows: ligand-patcher-env\Scripts\activate
pip install -e .
ligand-patcher --version
```

### Basic Usage

```bash
# Basic patching
ligand-patcher patch system-charmm-gui-123 ligand-charmm-gui-456

# Preview changes (recommended first)
ligand-patcher patch system-dir ligand-dir --dry-run --verbose

# Save to new directory
ligand-patcher patch system-dir ligand-dir --output patched-system
```

### Testing Installation

```bash
# Quick test
./quick_test.sh

# Comprehensive test suite
python test_installation.py
```

## ğŸ“ Input Requirements

### System Directory Structure
```
system-charmm-gui-xxx/
â”œâ”€â”€ gromacs/
â”‚   â”œâ”€â”€ step5_input.gro      # System coordinates
â”‚   â”œâ”€â”€ topol.top           # System topology
â”‚   â”œâ”€â”€ index.ndx           # Atom groups
â”‚   â””â”€â”€ step6.X_equilibration.mdp  # Equilibration parameters
```

### Ligand Directory Structure
```
ligand-charmm-gui-xxx/
â”œâ”€â”€ ligandrm.pdb            # Ligand coordinates
â”œâ”€â”€ ligandrm.yml            # Ligand metadata
â””â”€â”€ gromacs/
    â””â”€â”€ LIGAND.itp          # Ligand topology
```

## âš™ï¸ How It Works

The tool performs three automated steps:

### 1. ğŸ§¬ Coordinate Integration
- Extracts ligand atoms from `ligandrm.pdb`
- Converts PDB format to GROMACS GRO format
- Appends ligand coordinates to system GRO file
- Updates total atom count

### 2. ğŸ“Š Topology Updates
- Copies ligand ITP file to system topology directory
- Adds `#include "toppar/LIGAND.itp"` to main topology
- Updates `[molecules]` section with ligand entry

### 3. âš–ï¸ Restraint Configuration
- Adds ligand restraints to equilibration MDP files
- Configures `-DPOSRES_LIGAND -DPOSRES_FC_LIGAND=1000.0`
- Maintains existing system restraints

## ğŸ“– Usage Examples

### Command Line Interface

```bash
# Basic usage
ligand-patcher patch system-charmm-gui-123 ligand-charmm-gui-456

# Dry run with verbose output
ligand-patcher patch system-dir ligand-dir --dry-run --verbose

# Custom output directory
ligand-patcher patch system-dir ligand-dir --output my-patched-system

# Custom backup suffix
ligand-patcher patch system-dir ligand-dir --backup-suffix .original
```

### Programmatic Interface

```python
from ligand_patcher import LigandPatcher

# Basic usage
patcher = LigandPatcher("system-dir", "ligand-dir")
patcher.patch()

# With options
patcher = LigandPatcher(
    system_dir="system-charmm-gui-123",
    ligand_dir="ligand-charmm-gui-456", 
    output_dir="patched-system",
    dry_run=True
)
patcher.patch()
```

## ğŸ§ª Testing

The package includes comprehensive testing:

```bash
# Run all installation tests
python test_installation.py

# Quick validation
./quick_test.sh

# Manual testing with your data
ligand-patcher patch your-system your-ligand --dry-run
```

## ğŸ“‚ Output

After successful patching, you'll have:

- âœ… Updated coordinate file with ligand atoms
- âœ… Modified topology including ligand parameters  
- âœ… Equilibration files with ligand restraints configured
- âœ… Backup copies of all original files (`.backup` suffix)

## ğŸ”§ Troubleshooting

### Common Issues

**Missing files error**: Ensure your directories contain all required CHARMM-GUI files
```bash
ligand-patcher patch system-dir ligand-dir --dry-run  # Check what's missing
```

**Topology errors**: Verify ligand ITP file is properly formatted
```bash
# Check if ligand ITP exists
ls ligand-dir/gromacs/*.itp
```

**Permission errors**: Ensure write permissions in target directory
```bash
chmod -R u+w system-directory/
```

## ğŸ¤ Contributing

We welcome contributions! Please see [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines.

### Development Setup

```bash
git clone https://github.com/yourusername/ligand-patcher.git
cd ligand-patcher
conda env create -f environment.yml
conda activate ligand-patcher
```

## ğŸ“„ License

MIT License - see [LICENSE](LICENSE) file for details.

## ğŸ™ Acknowledgements

- **Xi'an Jiaotong-Liverpool University (XJTLU)** Summer Undergraduate Research Fellowship (SURF) codes: 1335, 1415
- **Contributors**: TXY (Initiator)
- **CHARMM-GUI Team** for the excellent membrane protein setup tools
- **GROMACS Development Team** for the molecular dynamics engine

## ğŸ“ Support

- **Issues**: [GitHub Issue Tracker](https://github.com/yourusername/ligand-patcher/issues)
- **Documentation**: See example files in `examples/`
- **Testing**: Comprehensive test suite included

---

<p align="center">
  <i>Streamlining GROMACS ligand integration for membrane protein simulations</i>
</p>