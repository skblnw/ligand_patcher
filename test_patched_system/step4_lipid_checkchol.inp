* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.7 on Aug, 05. 2025. JOBID=5442443097
* TEST AND FIX CHOLESTEROL RING PENERTRATION
*

DIMENS CHSIZE 5000000 MAXRES 3000000

! Read topology and parameter files
stream toppar.str

! Read the system information
stream step3_size.str
stream step4_components.str

! Read Lipids
open read unit 10 card name step4_lipid_lipid.psf
read psf  unit 10 card append

open read unit 10 card name step4_lipid_lipid.crd
read coor unit 10 card append

!
! Image Setup
!

open read unit 10 card name crystal_image.str
CRYSTAL DEFINE @XTLtype @A @B @C @alpha @beta @gamma
CRYSTAL READ UNIT 10 CARD

!Image centering by residue
IMAGE BYRESID XCEN 0.0 YCEN 0.0 ZCEN @zcen sele resname TIP3 .or. segid MEMB end

!
! Nonbonded Options
!

nbonds atom vatom vfswitch bycb -
       ctonnb 6.0 ctofnb 7.0 cutnb 10.0 cutim 10.0 -
       inbfrq -1 imgfrq -1 wmin 1.0 cdie eps 1.0 
energy

!
! Minimization 
!

mini sd   nstep 250
mini abnr nstep 250

!
! check lipid penetrating into cholesterol rings
!

set nres = ?nres

open write unit 90 card name step4_lipid_checkchol.str

define STEROL sele ( resn CHL1 .or. resn ERG .or. resn DPOP .or. resn SITO .or. resn STIG -
                 .or. resn CHSD .or. resn CHSP .or. resn CAMP .or. resn GCAMP .or. resn GSITO -
                 .or. resn GSTIG .or. resn LANO .or. resn PGCAMP .or. resn PGSITO .or. resn PGSTIG -
                 ) end

!loop for upper-leaflet sterols
define XXX sele STEROL .and. segid MEMB .and. type O3 .and. ( prop Z .gt. 0 ) end
set ncholtop = ?nsel
set i    = ?SELRESI

if ncholtop .gt. 0 then
  set icholtop = 1
  label dointer1
    define YYY sele XXX .and. resid @i:@nres end
    set i    = ?SELRESI
    inter select resid @i .and. segid MEMB end

    if ?bond .gt. 100 then
      write title unit 90
      * @i
      *
    endif

  increase i by 1
  increase icholtop by 1
  if icholtop .le. @ncholtop goto dointer1
endif

!loop for bottom-leaflet sterols
define XXX sele STEROL .and. segid MEMB .and. type O3 .and. ( prop Z .lt. 0 ) end
set ncholbot = ?nsel
set i    = ?SELRESI

if ncholbot .gt. 0 then
  set icholbot = 1
  label dointer2
    define YYY sele XXX .and. resid @i:@nres end
    set i    = ?SELRESI
    inter select resid @i .and. segid MEMB end

    if ?bond .gt. 100 then
      write title unit 90
      * @i
      *
    endif

  increase i by 1
  increase icholbot by 1
  if icholbot .le. @ncholbot goto dointer2
endif

stop
